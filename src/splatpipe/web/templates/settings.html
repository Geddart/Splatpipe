{% extends "base.html" %}
{% block title %}Settings â€” Splatpipe{% endblock %}

{% block content %}

{% if setup %}
<div class="alert alert-info mb-6 shadow-lg">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    <div>
        <h3 class="font-bold">Welcome to Splatpipe!</h3>
        <p>Set your projects folder and tool paths to get started. Click "Auto-detect tools" to find installed tools automatically.</p>
    </div>
</div>
{% endif %}

{% if saved is defined and saved %}
<div class="alert alert-success mb-6 shadow-lg" id="save-alert">
    <span>Settings saved successfully.</span>
</div>
<script>setTimeout(function(){ document.getElementById('save-alert').style.display='none'; }, 3000);</script>
{% endif %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Settings</h1>
    <div class="flex gap-2">
        <button class="btn btn-outline btn-sm" id="btn-detect"
                onclick="detectTools()">
            Auto-detect tools
        </button>
        <button class="btn btn-outline btn-sm" id="btn-check-deps"
                onclick="checkDeps()">
            System Check
        </button>
    </div>
</div>

<!-- System Check Panel (hidden until clicked) -->
<div id="deps-panel" class="hidden mb-6">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">System Check</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-bold text-sm mb-2">Python Packages</h3>
                    <div id="deps-list" class="space-y-1 text-sm font-mono"></div>
                </div>
                <div>
                    <h3 class="font-bold text-sm mb-2">External Tools</h3>
                    <div id="tools-status" class="space-y-1 text-sm font-mono">
                        {% for name, exists in tool_status.items() %}
                        <div class="flex items-center gap-2">
                            {% if exists %}
                            <span class="text-success">&#10003;</span>
                            {% else %}
                            <span class="text-error">&#10007;</span>
                            {% endif %}
                            <span>{{ name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form method="post" action="/settings/">
    {% if setup %}<input type="hidden" name="_setup" value="true">{% endif %}

    <div class="grid gap-6">

        <!-- Paths -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Paths</h2>
                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-mono text-sm">projects_root</span></label>
                    <div class="join w-full">
                        <input type="text" name="paths__projects_root" id="path-projects_root"
                               value="{{ config.get('paths', {}).get('projects_root', '') }}"
                               placeholder="e.g. H:\Projects\splatpipe_projects"
                               class="input input-bordered join-item w-full font-mono text-sm">
                        <button type="button" class="btn btn-outline join-item"
                                onclick="openBrowser('path-projects_root', 'dir')">Browse</button>
                    </div>
                    <label class="label"><span class="label-text-alt">Root folder where projects are stored</span></label>
                </div>
            </div>
        </div>

        <!-- Tool Paths -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Tool Paths</h2>
                <div class="space-y-3">
                    {% for name in ['postshot_cli', 'lichtfeld_studio', 'colmap', 'splat_transform', 'supersplat_url'] %}
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text font-mono text-sm">{{ name }}</span>
                            <span class="label-text-alt">
                                {% if tool_status.get(name) %}
                                <span class="text-success">&#10003; found</span>
                                {% else %}
                                <span class="text-error">&#10007; not found</span>
                                {% endif %}
                            </span>
                        </label>
                        {% if name == 'supersplat_url' %}
                        <input type="text" name="tools__{{ name }}" id="tool-{{ name }}"
                               value="{{ config.get('tools', {}).get(name, '') }}"
                               class="input input-bordered w-full font-mono text-sm">
                        {% else %}
                        <div class="join w-full">
                            <input type="text" name="tools__{{ name }}" id="tool-{{ name }}"
                                   value="{{ config.get('tools', {}).get(name, '') }}"
                                   class="input input-bordered join-item w-full font-mono text-sm">
                            <button type="button" class="btn btn-outline join-item"
                                    onclick="openBrowser('tool-{{ name }}', 'file')">Browse</button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- COLMAP Clean -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">COLMAP Clean</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="colmap_clean__outlier_threshold_auto"
                                   {% if config.get('colmap_clean', {}).get('outlier_threshold_auto', true) %}checked{% endif %}
                                   class="toggle toggle-primary">
                            <span class="label-text font-mono text-sm">outlier_threshold_auto</span>
                        </label>
                    </div>
                    {% for key in ['outlier_threshold_fixed', 'outlier_percentile', 'outlier_multiplier', 'kdtree_threshold'] %}
                    <div class="form-control">
                        <label class="label"><span class="label-text font-mono text-sm">{{ key }}</span></label>
                        <input type="number" step="any" name="colmap_clean__{{ key }}"
                               value="{{ config.get('colmap_clean', {}).get(key, '') }}"
                               class="input input-bordered input-sm font-mono text-sm">
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Postshot -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Postshot</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-mono text-sm">profile</span></label>
                        <input type="text" name="postshot__profile"
                               value="{{ config.get('postshot', {}).get('profile', 'Splat3') }}"
                               class="input input-bordered input-sm font-mono text-sm">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-mono text-sm">login</span></label>
                        <input type="text" name="postshot__login"
                               value="{{ config.get('postshot', {}).get('login', '') }}"
                               class="input input-bordered input-sm font-mono text-sm">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-mono text-sm">password</span></label>
                        <input type="password" name="postshot__password"
                               value="{{ config.get('postshot', {}).get('password', '') }}"
                               class="input input-bordered input-sm font-mono text-sm">
                    </div>
                </div>
            </div>
        </div>

        <!-- LichtFeld -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">LichtFeld Studio</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-mono text-sm">strategy</span></label>
                        <input type="text" name="lichtfeld__strategy"
                               value="{{ config.get('lichtfeld', {}).get('strategy', 'mcmc') }}"
                               class="input input-bordered input-sm font-mono text-sm">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text font-mono text-sm">iterations</span></label>
                        <input type="number" name="lichtfeld__iterations"
                               value="{{ config.get('lichtfeld', {}).get('iterations', 30000) }}"
                               class="input input-bordered input-sm font-mono text-sm">
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="flex justify-end">
            <button type="submit" class="btn btn-primary btn-wide">Save Settings</button>
        </div>
    </div>
</form>

<!-- Browse Modal -->
<dialog id="browse-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-2">Browse</h3>
        <!-- Current path bar -->
        <div class="flex items-center gap-2 mb-3">
            <button class="btn btn-ghost btn-sm" onclick="browseUp()" id="browse-up-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
            </button>
            <input type="text" id="browse-path-input" class="input input-bordered input-sm w-full font-mono text-sm"
                   placeholder="Type a path and press Enter"
                   onkeydown="if(event.key==='Enter'){event.preventDefault();browseNavigate(this.value);}">
        </div>
        <!-- File listing -->
        <div id="browse-list" class="overflow-y-auto max-h-80 border border-base-300 rounded-lg">
            <div class="text-center p-4 opacity-60">Loading...</div>
        </div>
        <!-- Action buttons -->
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeBrowser()">Cancel</button>
            <button class="btn btn-primary" id="browse-select-btn" onclick="selectBrowsed()">Select</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
var _browseTarget = null;  // input element ID to fill
var _browseMode = 'dir';   // 'dir' or 'file'
var _browseCurrent = '';    // current directory path
var _browseSelected = '';   // selected path (for files)

function openBrowser(targetId, mode) {
    _browseTarget = targetId;
    _browseMode = mode;
    _browseSelected = '';
    // Start from the current value in the input, or root
    var startPath = document.getElementById(targetId).value || '';
    // For file paths, start from the parent directory
    if (mode === 'file' && startPath) {
        var idx = Math.max(startPath.lastIndexOf('\\'), startPath.lastIndexOf('/'));
        if (idx > 0) startPath = startPath.substring(0, idx);
    }
    document.getElementById('browse-modal').showModal();
    browseNavigate(startPath);
}

function closeBrowser() {
    document.getElementById('browse-modal').close();
}

function selectBrowsed() {
    var path = _browseMode === 'file' ? _browseSelected : _browseCurrent;
    if (path && _browseTarget) {
        document.getElementById(_browseTarget).value = path;
    }
    closeBrowser();
}

function browseUp() {
    fetch('/settings/browse?path=' + encodeURIComponent(_browseCurrent) + '&mode=' + _browseMode)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            browseNavigate(data.parent || '');
        });
}

function browseNavigate(path) {
    _browseCurrent = path;
    _browseSelected = '';
    document.getElementById('browse-path-input').value = path;
    var list = document.getElementById('browse-list');
    list.innerHTML = '<div class="text-center p-4"><span class="loading loading-spinner loading-sm"></span></div>';

    fetch('/settings/browse?path=' + encodeURIComponent(path) + '&mode=' + _browseMode)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            _browseCurrent = data.current || path;
            document.getElementById('browse-path-input').value = _browseCurrent;

            if (data.error) {
                list.innerHTML = '<div class="text-center p-4 text-error">' + data.error + '</div>';
                return;
            }

            if (data.entries.length === 0) {
                list.innerHTML = '<div class="text-center p-4 opacity-60">Empty folder</div>';
                return;
            }

            var html = '<ul class="menu menu-sm bg-base-100 w-full">';
            data.entries.forEach(function(entry) {
                var icon = entry.is_dir
                    ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-warning inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-info inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';

                if (entry.is_dir) {
                    html += '<li><a onclick="browseNavigate(\'' + entry.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\')">'
                         + icon + entry.name + '</a></li>';
                } else {
                    html += '<li><a class="browse-file-entry" data-path="' + entry.path.replace(/"/g, '&quot;') + '" onclick="selectFile(this)">'
                         + icon + entry.name + '</a></li>';
                }
            });
            html += '</ul>';
            list.innerHTML = html;
        });
}

function selectFile(el) {
    // Deselect previous
    document.querySelectorAll('.browse-file-entry.active').forEach(function(a) { a.classList.remove('active'); });
    el.classList.add('active');
    _browseSelected = el.getAttribute('data-path');
}

function detectTools() {
    var btn = document.getElementById('btn-detect');
    btn.classList.add('loading');
    fetch('/settings/detect-tools')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            for (var name in data) {
                var input = document.getElementById('tool-' + name);
                if (input && data[name]) {
                    input.value = data[name];
                    input.classList.add('input-success');
                    setTimeout(function(el) { el.classList.remove('input-success'); }.bind(null, input), 2000);
                }
            }
            btn.classList.remove('loading');
        })
        .catch(function() { btn.classList.remove('loading'); });
}

function checkDeps() {
    var panel = document.getElementById('deps-panel');
    panel.classList.remove('hidden');
    var list = document.getElementById('deps-list');
    list.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Checking...';
    fetch('/settings/check-deps')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var html = '';
            for (var pkg in data) {
                var ok = data[pkg];
                html += '<div class="flex items-center gap-2">';
                html += ok ? '<span class="text-success">&#10003;</span>' : '<span class="text-error">&#10007;</span>';
                html += '<span>' + pkg + '</span></div>';
            }
            list.innerHTML = html;
        });
}
</script>

{% endblock %}
