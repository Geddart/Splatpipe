{% extends "base.html" %}
{% block title %}New Project â€” Splatpipe{% endblock %}

{% block content %}
<div class="flex items-center gap-4 mb-6">
    <a href="/" class="btn btn-ghost btn-sm">&larr; Back</a>
    <h1 class="text-3xl font-bold">New Project</h1>
</div>

{% if error %}
<div class="alert alert-error mb-6 shadow-lg">
    <span>{{ error }}</span>
</div>
{% endif %}

<form method="post" action="/projects/new">
    <div class="grid gap-6">

        <!-- Basic Info -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Project Info</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text">Project Name</span></label>
                        <input type="text" name="name" value="{{ values.get('name', '') }}"
                               placeholder="My Scan"
                               class="input input-bordered w-full" required>
                    </div>
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text">COLMAP Data Directory</span></label>
                        <div class="join w-full">
                            <input type="text" name="colmap_dir" id="path-colmap_dir" value="{{ values.get('colmap_dir', '') }}"
                                   placeholder="H:\path\to\colmap\export"
                                   class="input input-bordered join-item w-full font-mono text-sm" required>
                            <button type="button" class="btn btn-outline join-item"
                                    onclick="openBrowser('path-colmap_dir', 'dir')">Browse</button>
                        </div>
                        <label class="label"><span class="label-text-alt">Must contain cameras.txt, images.txt, points3D.txt</span></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Training</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text">Trainer</span></label>
                        <select name="trainer" class="select select-bordered w-full">
                            <option value="postshot" {% if values.get('trainer', 'postshot') == 'postshot' %}selected{% endif %}>Postshot</option>
                            <option value="lichtfeld" {% if values.get('trainer') == 'lichtfeld' %}selected{% endif %}>LichtFeld Studio</option>
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text">LOD Levels</span></label>
                        <input type="text" name="lods" value="{{ values.get('lods', '20M,10M,5M,3M,1.5M') }}"
                               class="input input-bordered w-full font-mono text-sm">
                        <label class="label"><span class="label-text-alt">Comma-separated: 20M,10M,5M,3M,1.5M (M=million, K=thousand)</span></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Toggles -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Pipeline Steps</h2>
                <p class="text-sm opacity-60 mb-3">Enable or disable steps for this project.</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for step_name, label in [('clean', 'Clean COLMAP'), ('train', 'Train Splats'), ('assemble', 'Assemble LODs'), ('deploy', 'Deploy to CDN')] %}
                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="step_{{ step_name }}"
                                   {% if values.get('step_' + step_name, 'on') %}checked{% endif %}
                                   class="toggle toggle-primary">
                            <span class="label-text">{{ label }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="flex justify-end">
            <button type="submit" class="btn btn-primary btn-wide">Create Project</button>
        </div>
    </div>
</form>

<!-- Browse Modal -->
<dialog id="browse-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-2">Browse</h3>
        <div class="flex items-center gap-2 mb-3">
            <button class="btn btn-ghost btn-sm" onclick="browseUp()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
            </button>
            <input type="text" id="browse-path-input" class="input input-bordered input-sm w-full font-mono text-sm"
                   placeholder="Type a path and press Enter"
                   onkeydown="if(event.key==='Enter'){event.preventDefault();browseNavigate(this.value);}">
        </div>
        <div id="browse-list" class="overflow-y-auto max-h-80 border border-base-300 rounded-lg">
            <div class="text-center p-4 opacity-60">Loading...</div>
        </div>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeBrowser()">Cancel</button>
            <button class="btn btn-primary" onclick="selectBrowsed()">Select</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script>
var _browseTarget = null, _browseMode = 'dir', _browseCurrent = '', _browseSelected = '';

function openBrowser(targetId, mode) {
    _browseTarget = targetId; _browseMode = mode; _browseSelected = '';
    var startPath = document.getElementById(targetId).value || '';
    document.getElementById('browse-modal').showModal();
    browseNavigate(startPath);
}
function closeBrowser() { document.getElementById('browse-modal').close(); }
function selectBrowsed() {
    var path = _browseMode === 'file' ? _browseSelected : _browseCurrent;
    if (path && _browseTarget) document.getElementById(_browseTarget).value = path;
    closeBrowser();
}
function browseUp() {
    fetch('/settings/browse?path=' + encodeURIComponent(_browseCurrent) + '&mode=' + _browseMode)
        .then(function(r) { return r.json(); })
        .then(function(data) { browseNavigate(data.parent || ''); });
}
function browseNavigate(path) {
    _browseCurrent = path; _browseSelected = '';
    document.getElementById('browse-path-input').value = path;
    var list = document.getElementById('browse-list');
    list.innerHTML = '<div class="text-center p-4"><span class="loading loading-spinner loading-sm"></span></div>';
    fetch('/settings/browse?path=' + encodeURIComponent(path) + '&mode=' + _browseMode)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            _browseCurrent = data.current || path;
            document.getElementById('browse-path-input').value = _browseCurrent;
            if (data.error) { list.innerHTML = '<div class="text-center p-4 text-error">' + data.error + '</div>'; return; }
            if (data.entries.length === 0) { list.innerHTML = '<div class="text-center p-4 opacity-60">Empty folder</div>'; return; }
            var html = '<ul class="menu menu-sm bg-base-100 w-full">';
            data.entries.forEach(function(entry) {
                var icon = entry.is_dir
                    ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-warning inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-info inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';
                if (entry.is_dir) {
                    html += '<li><a onclick="browseNavigate(\'' + entry.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\')">' + icon + entry.name + '</a></li>';
                } else {
                    html += '<li><a class="browse-file-entry" data-path="' + entry.path.replace(/"/g, '&quot;') + '" onclick="selectFile(this)">' + icon + entry.name + '</a></li>';
                }
            });
            list.innerHTML = html + '</ul>';
        });
}
function selectFile(el) {
    document.querySelectorAll('.browse-file-entry.active').forEach(function(a) { a.classList.remove('active'); });
    el.classList.add('active');
    _browseSelected = el.getAttribute('data-path');
}
</script>
{% endblock %}
